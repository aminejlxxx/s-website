<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Explicit Selfie Upload</title>
<style>
  body{font-family:Inter,system-ui,Arial;margin:24px;background:#071028;color:#e6eef6}
  .card{max-width:720px;padding:18px;border-radius:10px;background:rgba(255,255,255,0.03)}
  button{padding:10px 14px;border-radius:8px;border:none;background:#06b6d4;color:#062028;cursor:pointer;font-weight:600}
  .small{font-size:13px;color:#94a3b8;margin-top:8px}
  video{display:block;width:100%;max-height:360px;border-radius:8px;background:#000}
  img{max-width:100%;border-radius:8px}
</style>
</head>
<body>
  <div class="card">
    <h2 style="margin:0 0 8px 0">Explicit selfie uploader</h2>
    <div class="small">
      By clicking the button you explicitly consent to this page taking a single selfie and uploading it to the site admin.
    </div>

    <div style="margin-top:12px">
      <button id="startBtn">Take selfie and send to admin</button>
    </div>

    <div id="status" class="small" style="margin-top:12px">Status: waiting for user action.</div>

    <div id="cameraArea" style="margin-top:12px;display:none">
      <video id="video" autoplay playsinline></video>
    </div>

    <div id="previewArea" style="margin-top:12px;display:none">
      <strong>Preview</strong>
      <div id="preview" style="margin-top:8px"></div>
    </div>
  </div>

<script>
(async function(){
  const startBtn = document.getElementById('startBtn');
  const status = document.getElementById('status');
  const video = document.getElementById('video');
  const cameraArea = document.getElementById('cameraArea');
  const previewArea = document.getElementById('previewArea');
  const preview = document.getElementById('preview');
  let stream = null;

  function stopStream(){
    if(stream){ stream.getTracks().forEach(t => t.stop()); stream = null; }
  }

  async function uploadBlob(blob){
    const fd = new FormData();
    fd.append('selfie', blob, 'selfie.jpg');
    // optional: add metadata so admin knows this was consented
    fd.append('consent', 'user_clicked_take_selfie_button');
    try{
      status.textContent = 'Status: uploading...';
      const res = await fetch('/upload', { method:'POST', body: fd });
      if(!res.ok) throw new Error('Upload failed: ' + res.status);
      const json = await res.json();
      status.textContent = 'Status: uploaded — server saved as: ' + (json.filename || 'unknown');
    }catch(err){
      console.error(err);
      status.textContent = 'Status: upload failed';
    }
  }

  function takePhotoAndUpload(){
    if(!video.videoWidth){ status.textContent = 'Status: camera not ready'; return; }
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    // mirror to match user-facing camera
    ctx.translate(canvas.width, 0);
    ctx.scale(-1,1);
    ctx.drawImage(video, 0, 0);
    canvas.toBlob(async (blob) => {
      // show preview
      previewArea.style.display = '';
      preview.innerHTML = '';
      const img = document.createElement('img');
      img.src = URL.createObjectURL(blob);
      preview.appendChild(img);

      // upload
      await uploadBlob(blob);

      // stop camera
      stopStream();
      cameraArea.style.display = 'none';
    }, 'image/jpeg', 0.92);
  }

  startBtn.addEventListener('click', async () => {
    status.textContent = 'Status: requesting camera permission...';
    try {
      cameraArea.style.display = '';
      // explicit setting: user-facing camera
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
      video.srcObject = stream;
      status.textContent = 'Status: camera permission granted — taking selfie now';
      // ensure video has metadata
      video.addEventListener('loadedmetadata', () => {
        // give a very short delay so user sees video for a split second if desired
        setTimeout(takePhotoAndUpload, 500);
      }, { once: true });
    } catch (e) {
      console.error(e);
      status.textContent = 'Status: camera permission denied or not available';
      cameraArea.style.display = 'none';
    }
  });

  // cleanup when page closes
  window.addEventListener('pagehide', stopStream);
})();
</script>
</body>
</html>




